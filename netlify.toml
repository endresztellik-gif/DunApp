# Netlify Configuration for DunApp PWA
# https://docs.netlify.com/configure-builds/file-based-configuration/

[build]
  command = "npm run build"
  publish = "dist"
  functions = "netlify/functions"

[build.environment]
  NODE_VERSION = "20"
  NPM_FLAGS = "--legacy-peer-deps"

# Security Headers (OWASP Best Practices)
[[headers]]
  for = "/*"
  [headers.values]
    # Content Security Policy (OWASP A05 Compliant - No unsafe directives)
    Content-Security-Policy = """
      default-src 'self';
      script-src 'self' https://unpkg.com;
      style-src 'self' https://unpkg.com https://fonts.googleapis.com 'unsafe-inline';
      style-src-elem 'self' https://unpkg.com https://fonts.googleapis.com 'unsafe-inline';
      img-src 'self' data: https: blob: https://www.met.hu https://odp.met.hu;
      font-src 'self' https://fonts.gstatic.com;
      connect-src 'self' https://*.supabase.co https://api.openweathermap.org https://api.met.no https://api.rainviewer.com https://tilecache.rainviewer.com https://odp.met.hu https://archive-api.open-meteo.com https://map.hugeo.hu https://ovfgis2.vizugy.hu https://*.tile.openstreetmap.org wss://*.supabase.co;
      frame-src 'self';
      base-uri 'self';
      form-action 'self';
      frame-ancestors 'none';
      upgrade-insecure-requests;
    """

    # Strict Transport Security (HSTS)
    Strict-Transport-Security = "max-age=31536000; includeSubDomains; preload"

    # Prevent MIME type sniffing
    X-Content-Type-Options = "nosniff"

    # Enable XSS Protection
    X-XSS-Protection = "1; mode=block"

    # Prevent clickjacking
    X-Frame-Options = "DENY"

    # Referrer Policy
    Referrer-Policy = "strict-origin-when-cross-origin"

    # Permissions Policy (formerly Feature-Policy)
    Permissions-Policy = "geolocation=(), microphone=(), camera=(), payment=()"

    # Cross-Origin Policies (MEDIUM-03 Fix)
    Cross-Origin-Resource-Policy = "same-origin"
    Cross-Origin-Embedder-Policy = "credentialless"
    Cross-Origin-Opener-Policy = "same-origin"

    # Prevent Adobe Flash/PDF XSS
    X-Permitted-Cross-Domain-Policies = "none"

    # DNS Prefetch Control (privacy)
    X-DNS-Prefetch-Control = "off"

# Cache static assets
[[headers]]
  for = "/assets/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# Cache images
[[headers]]
  for = "/icons/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# Service Worker - no cache
[[headers]]
  for = "/sw.js"
  [headers.values]
    Cache-Control = "no-cache, no-store, must-revalidate"

# Manifest - cache for 1 day
[[headers]]
  for = "/manifest.json"
  [headers.values]
    Cache-Control = "public, max-age=86400"

# Redirects
[[redirects]]
  from = "/api/*"
  to = "https://zpwoicpajmvbtmtumsah.supabase.co/:splat"
  status = 200
  force = true

# Proxy for met.hu images to avoid CORS errors
[[redirects]]
  from = "/met-img/*"
  to = "https://www.met.hu/img/:splat"
  status = 200
  force = true

# Proxy for met.hu ODP radar images
[[redirects]]
  from = "/met-radar/*"
  to = "https://odp.met.hu/weather/radar/composite/png/refl2D/:splat"
  status = 200
  force = true

# Proxy for Open-Meteo Historical API (precipitation data)
[[redirects]]
  from = "/open-meteo-archive/*"
  to = "https://archive-api.open-meteo.com/v1/:splat"
  status = 200
  force = true

# SPA fallback
[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200

# Plugin - Lighthouse CI
[[plugins]]
  package = "@netlify/plugin-lighthouse"

  [plugins.inputs]
    output_path = "reports/lighthouse.html"

  [plugins.inputs.thresholds]
    performance = 0.9
    accessibility = 0.9
    best-practices = 0.9
    seo = 0.9
    pwa = 0.9
